@page "/Profile"
@using ShopApp.Models
@using ShopApp.Services
@inject AuthService AuthService
@inject OrderService OrderService
@inject Blazored.Toast.Services.IToastService ToastService

<div class="container mt-5">
    <h3>Профиль</h3>

    @if (currentUser == null)
    {
        <p>Загрузка...</p>
    }
    else
    {
        <h4>Добро пожаловать, @currentUser.FullName!</h4>
        <p>Email: @currentUser.Email</p>
        <p>Дата регистрации: @currentUser.RegistrationDate.ToString("d")</p>

        <h5>Ваши заказы</h5>
        @if (orders == null || !orders.Any())
        {
            <p>У вас нет заказов.</p>
        }
        else
        {
            <ul>
                @foreach (var order in orders)
                {
                    <li>
                        Заказ #@order.Id от @order.CreatedDate.ToString("d") - Статус: @order.Status, Сумма: @order.Total
                    </li>
                }
            </ul>
        }
    }
</div>

@code {
    private AuthenticatedUser? currentUser;
    private List<OrderClient> orders = new();

    protected override async Task OnInitializedAsync()
    {
        currentUser = await AuthService.GetCurrentUserAsync();
        if (currentUser != null)
        {
            try
            {
                orders = await OrderService.GetUserOrdersAsync(currentUser.Id);
            }
            catch (Exception ex)
            {
                ToastService.ShowError($"Failed to load orders: {ex.Message}");
            }
        }
    }
}